# Session-Based Authentication with URL Shortener - Complete Implementation

## Overview (From lecture 80-89 )
Complete URL Shortener with user authentication, protected routes, CRUD operations, and Zod validation using Express.js, Drizzle ORM, and MySQL.


## 1. Database Schema with Primary & Foreign Keys

### Schema Definition (`drizzle/schema.js`)
```javascript
import { mysqlTable, serial, timestamp, varchar, int } from 'drizzle-orm/mysql-core';
import { relations } from 'drizzle-orm';

// Users table with Primary Key
export const usersTable = mysqlTable('users', {
  id: int('id').autoincrement().primaryKey(), // Primary Key
  name: varchar('name', { length: 255 }).notNull(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  password: varchar('password', { length: 255 }).notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().onUpdateNow().notNull(),
});

// Short Links table with Foreign Key
export const short_links = mysqlTable('short_links', {
  id: serial('id').primaryKey(), // Primary Key
  shortCode: varchar('shortCode', { length: 16 }).notNull().unique(),
  url: varchar('url', { length: 2048 }).notNull(),
  userId: int("user_id").notNull().references(() => usersTable.id), // Foreign Key
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().onUpdateNow().notNull(),
});

// Define Relationships
export const usersRelation = relations(usersTable, ({ many }) => ({
  shortLinks: many(short_links), // One user has many short links
}));

export const shortLinksrelations = relations(short_links, ({ one }) => ({
  user: one(usersTable, {
    fields: [short_links.userId], // Foreign key field
    references: [usersTable.id],  // References primary key
  })
}));
```

### Database Commands
```bash
npm run db:generate  # Generate migrations
npm run db:migrate   # Apply migrations
```

## 2. Authentication System

### Zod Validation (`validators/auth-validator.js`)
```javascript
import z from "zod";

export const loginUserSchema = z.object({
  email: z.string().trim().email({ message: "Please enter a valid email" }),
  password: z.string().trim().min(5, { message: "Password must be at least 5 chars long" }),
});

export const registerUserSchema = loginUserSchema.extend({
  name: z.string().trim()
    .min(3, { message: "Name must be at least 3 chars long" })
    .max(100, { message: "Name must be less than 100 chars" })
});
```

### Authentication Services (`services/auth.services.js`)
```javascript
import { db } from "../config/db-client.js";
import { usersTable } from "../drizzle/schema.js";
import { eq } from "drizzle-orm";
import argon2 from "argon2";
import jwt from "jsonwebtoken";

export const getUserByEmail = async (email) => {
  const [user] = await db.select().from(usersTable).where(eq(usersTable.email, email));
  return user;
};

export const createUser = async ({ name, email, password }) => {
  return await db.insert(usersTable).values({ name, email, password }).$returningId();
};

export const hashPassword = async (password) => {
  return await argon2.hash(password);
};

export const comparePassword = async (hash, password) => {
  return await argon2.verify(hash, password);
};

export const generateToken = ({ id, name, email }) => {
  return jwt.sign({ id, name, email }, process.env.JWT_SECRET, { expiresIn: "30d" });
};

export const verifyJWTToken = (token) => {
  return jwt.verify(token, process.env.JWT_SECRET);
};
```

### Authentication Controllers (`controllers/auth.controller.js`)
```javascript
import { registerUserSchema, loginUserSchema } from "../validators/auth-validator.js";
import { getUserByEmail, createUser, hashPassword, comparePassword, generateToken } from "../services/auth.services.js";

export const postRegister = async (req, res) => {
  if (req.user) return res.redirect("/");

  // Zod Validation
  const { success, data, error } = registerUserSchema.safeParse(req.body);
  
  if (!success) {
    const errorMessage = error.issues?.[0]?.message || "Validation error";
    req.flash("errors", errorMessage);
    return res.redirect('/register');
  }

  const { name, email, password } = data;
  
  // Check if user exists
  const userExists = await getUserByEmail(email);
  if (userExists) {
    req.flash("errors", "User Already Exists.");
    return res.redirect("/register");
  }

  // Hash password and create user
  const hashedPassword = await hashPassword(password);
  await createUser({ name, email, password: hashedPassword });
  
  res.redirect("/login");
};

export const postLogin = async (req, res) => {
  if (req.user) return res.redirect("/");
  
  // Zod Validation
  const { success, data, error } = loginUserSchema.safeParse(req.body);
  
  if (!success) {
    const errorMessage = error.issues?.[0]?.message || "Validation error";
    req.flash("errors", errorMessage);
    return res.redirect('/login');
  }

  const { email, password } = data;
  
  // Verify user credentials
  const user = await getUserByEmail(email);
  if (!user || !(await comparePassword(user.password, password))) {
    req.flash("errors", "Invalid User or Password");
    return res.redirect("/login");
  }

  // Generate JWT token and set cookie
  const token = generateToken({ id: user.id, name: user.name, email: user.email });
  res.cookie("access_token", token);
  res.redirect("/");
};
```

## 3. Protected Routes Middleware

### Authentication Middleware (`middlewares/verify-auth.middleware.js`)
```javascript
import { verifyJWTToken } from "../services/auth.services.js";

export const verifyAuthentication = (req, res, next) => {
  const token = req.cookies.access_token;
  
  if (!token) {
    req.user = null;
    return next();
  }
  
  try {
    const decodedToken = verifyJWTToken(token);
    req.user = decodedToken; // Attach user to request
  } catch (error) {
    console.log("Error verifying JWT Token", error);
    req.user = null;
  }
  
  return next();
};
```

### Route Protection Implementation
```javascript
// In controllers - Check authentication before operations
export const postShortner = async (req, res) => {
  // Protect route - require authentication
  if (!req.user) {
    req.flash("errors", "You must be logged in to create short links");
    return res.redirect("/login");
  }
  
  // Continue with authenticated logic...
};
```

## 4. User-Specific Data Display

### Services with User Filtering (`services/shortner.services.js`)
```javascript
import { db } from "../config/db-client.js";
import { eq, desc } from 'drizzle-orm';
import { short_links } from '../drizzle/schema.js';

// Load only user's links
export const loadLinks = async (userId) => {
  try {
    const rows = await db.select()
      .from(short_links)
      .where(eq(short_links.userId, userId))  // Filter by user ID
      .orderBy(desc(short_links.id));
    
    return rows;
  } catch (error) {
    console.error("Error loading links:", error);
    return [];
  }
};

// Save link with user association
export const saveLinks = async (shortCode, url, userId) => {
  try {
    const result = await db.insert(short_links).values({ 
      shortCode, 
      url, 
      userId  // Associate with user
    });
    return result;
  } catch (error) {
    if (error.code === 'ER_DUP_ENTRY') {
      throw new Error('Short code already exists');
    }
    throw error;
  }
};
```

### Controller Implementation
```javascript
export const getShortnerpage = async (req, res) => {
  try {
    // Load only current user's links
    const userId = req.user ? req.user.id : null;
    const links = await loadLinks(userId);
    
    const shortcodesList = links.map(link => ({
      shortCode: link.shortCode,
      url: link.url,
      host: req.get('host'),
      id: link.id
    }));
    
    return res.render('index', { 
      links: shortcodesList,
      isLoggedIn: !!req.user,
      errors: req.flash("errors")
    });
  } catch (error) {
    console.error("Error loading homepage:", error);
    return res.status(500).send("Internal Server Error");
  }
};
```

## 5. CRUD Operations (Edit, Update, Delete, Copy)

### URL Shortener Zod Validation (`validators/shortner-validator.js`)
```javascript
import z from "zod";

export const shortnerSchema = z.object({
  url: z.string().trim().url({ message: "Please enter a valid URL" }),
  shortcode: z.string().trim()
    .min(3, { message: "Short code must be at least 3 characters" })
    .max(16, { message: "Short code must be less than 16 characters" })
    .optional()
});
```

### CRUD Services
```javascript
// Find by ID
export const findShortLinkById = async (id) => {
  try {
    const rows = await db.select()
      .from(short_links)
      .where(eq(short_links.id, id));
    return rows[0] || null;
  } catch (error) {
    console.error("Error getting shortlink by id", error);
    return null;
  }
};

// Update by ID
export const updateShortLinkById = async (id, url, shortCode, userId) => {
  try {
    const result = await db.update(short_links)
      .set({ url, shortCode })
      .where(eq(short_links.id, id));
    return result;
  } catch (error) {
    if (error.code === 'ER_DUP_ENTRY') {
      throw new Error('Short code already exists');
    }
    throw error;
  }
};

// Delete by ID
export const deleteShortCodeById = async (id) => {
  try {
    const delRes = await db.delete(short_links)
      .where(eq(short_links.id, id));
    return delRes;
  } catch (error) {
    console.error("Error deleting link:", error);
  }
};
```

### CRUD Controllers
```javascript
// GET Edit Page
export const getShortenerEditPage = async (req, res) => {
  if (!req.user) return res.redirect("/login");

  const { data: id, error } = z.coerce.number().int().safeParse(req.params.id);
  if (error) return res.redirect("/404");

  try {
    const shortLink = await findShortLinkById(id);
    if (!shortLink) return res.redirect("/404");

    // Check ownership
    if (shortLink.userId !== req.user.id) {
      req.flash("errors", "You can only edit your own links");
      return res.redirect("/");
    }

    res.render("edit-shortLink", {
      id: shortLink.id,
      url: shortLink.url,
      shortCode: shortLink.shortCode,
      errors: req.flash("errors"),
    });
  } catch (error) {
    return res.status(500).send("Internal Server Error");
  }
};

// POST Update
export const updateShortLink = async (req, res) => {
  try {
    if (!req.user) return res.redirect("/login");

    const { data: id, error: idError } = z.coerce.number().int().safeParse(req.params.id);
    if (idError) {
      req.flash("errors", "Invalid link ID");
      return res.redirect("/");
    }

    const { url, shortCode } = req.body;
    
    // Zod validation
    const validation = shortnerSchema.safeParse({ url, shortcode: shortCode });
    if (!validation.success) {
      const errorMessages = validation.error.issues.map(issue => issue.message);
      errorMessages.forEach(message => req.flash("errors", message));
      return res.redirect(`/edit/${id}`);
    }

    // Verify ownership
    const existingLink = await findShortLinkById(id);
    if (!existingLink || existingLink.userId !== req.user.id) {
      req.flash("errors", "You can only edit your own links");
      return res.redirect("/");
    }

    // Check for duplicate shortcode
    if (shortCode !== existingLink.shortCode) {
      const duplicateLink = await getLinkByShortCode(shortCode);
      if (duplicateLink && duplicateLink.id !== id) {
        req.flash("errors", "Short code already exists");
        return res.redirect(`/edit/${id}`);
      }
    }

    // Update
    await updateShortLinkById(id, url, shortCode, req.user.id);
    return res.redirect("/");
  } catch (error) {
    req.flash("errors", "Error updating short link");
    return res.redirect("/");
  }
};

// POST Delete
export const deletShortCode = async (req, res) => {
  try {
    if (!req.user) return res.redirect("/login");

    const { data: id, error } = z.coerce.number().int().safeParse(req.params.id);
    if (error) return res.redirect("/404");

    // Verify ownership before deleting
    const existingLink = await findShortLinkById(id);
    if (!existingLink || existingLink.userId !== req.user.id) {
      req.flash("errors", "You can only delete your own links");
      return res.redirect("/");
    }

    await deleteShortCodeById(id);
    return res.redirect("/");
  } catch (error) {
    return res.status(500).send("Internal Server Error");
  }
};
```

## 6. Route Configuration

### Authentication Routes (`routes/auth.routes.js`)
```javascript
import { Router } from "express";
import * as authControllers from "../controllers/auth.controller.js";

const router = Router();

router.route("/register")
  .get(authControllers.getRegisterPage)
  .post(authControllers.postRegister);

router.route("/login")
  .get(authControllers.getLoginPage)
  .post(authControllers.postLogin);

router.route("/logout")
  .get(authControllers.logoutUser);

export const authRoutes = router;
```

### Main Routes (`routes/shortner.routes.js`)
```javascript
import { Router } from "express";
import { 
  postShortner, 
  getShortnerpage, 
  redirectShortCode, 
  getShortenerEditPage, 
  updateShortLink,
  deletShortCode 
} from "../controllers/postShortner.controller.js";

const router = Router();

router.get("/", getShortnerpage);                    // Homepage
router.post('/', postShortner);                      // Create short link
router.get("/:shortcode", redirectShortCode);        // Redirect short codes

// CRUD routes
router.route("/edit/:id")
  .get(getShortenerEditPage)   // GET edit form
  .post(updateShortLink);      // POST update

router.route("/delete/:id")
  .post(deletShortCode);       // POST delete

export default router;
```

## 7. App Configuration (`app.js`)

```javascript
import express from "express";
import cookieParser from 'cookie-parser';
import session from 'express-session';
import flash from 'connect-flash';
import { verifyAuthentication } from './middlewares/verify-auth.middleware.js';
import { authRoutes } from './routes/auth.routes.js';
import RouterUrl from "./routes/shortner.routes.js";

const app = express();

// Middleware setup order is important
app.use(express.urlencoded({ extended: true }));
app.use(cookieParser());
app.use(session({
  secret: 'my-secret',
  resave: true,
  saveUninitialized: false
}));
app.use(flash());
app.use(verifyAuthentication); // JWT verification

// Make user available in all templates
app.use((req, res, next) => {
  res.locals.user = req.user;
  return next();
});

// Routes
app.use(authRoutes);
app.use('/', RouterUrl);
```

## Key Features Achieved

✅ **Database with Relations**: Primary keys, foreign keys, and proper relationships  
✅ **Protected Routes**: JWT-based authentication with middleware  
✅ **User-Specific Data**: Each user sees only their own links  
✅ **Full CRUD**: Create, Read, Update, Delete with ownership verification  
✅ **Zod Validation**: Complete input validation for all forms  
✅ **Flash Messages**: Error handling and user feedback  
✅ **Session Management**: Login/logout with secure cookies  

## Security Features

- Password hashing with Argon2
- JWT token authentication
- Owner verification for all operations
- Input validation with Zod
- SQL injection protection via Drizzle ORM
- XSS protection with proper templating
